

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>KDataPy.util &mdash; KDataPy 5.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="KDataPy 5.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">KDataPy 5.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for KDataPy.util</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">KDataPy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">KDataPy.exceptions</span>
<span class="kn">from</span> <span class="nn">ROOT</span> <span class="kn">import</span> <span class="n">gSystem</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">gSystem</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="s">&#39;libkds&#39;</span><span class="p">)</span>
  <span class="n">gSystem</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="s">&#39;libkpta&#39;</span><span class="p">)</span>
  <span class="n">gSystem</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="s">&#39;libkamping&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> 
  <span class="k">print</span> <span class="s">&quot;failed to load KDataPy. Couldn&#39;t load one of the libraries: libkds, libkpta or libkamping&quot;</span>
  <span class="k">raise</span> <span class="n">e</span>


<span class="c">#add various iterators to KData objects</span>

<span class="kn">import</span> <span class="nn">libPyROOT</span> <span class="kn">as</span> <span class="nn">_libpyroot</span>

<span class="k">def</span> <span class="nf">_KEvent_iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetEntry</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetEvent</span><span class="p">()</span>                   
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">_libpyroot</span><span class="o">.</span><span class="n">MakeRootClass</span><span class="p">(</span> <span class="s">&quot;KDataReader&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">__iter__</span>    <span class="o">=</span> <span class="n">_KEvent_iter__</span>


<span class="k">def</span> <span class="nf">_KRawBoloPulseRecord_getNumpArray__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetTrace</span><span class="p">())</span>
<span class="n">_libpyroot</span><span class="o">.</span><span class="n">MakeRootClass</span><span class="p">(</span> <span class="s">&quot;KRawBoloPulseRecord&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">getnumpy</span>    <span class="o">=</span> <span class="n">_KRawBoloPulseRecord_getNumpArray__</span>


<span class="k">def</span> <span class="nf">_KptaProc_input_iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetInputPulseSize</span><span class="p">():</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetInputPulse</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>                 
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">_libpyroot</span><span class="o">.</span><span class="n">MakeRootClass</span><span class="p">(</span> <span class="s">&quot;KPtaProcessor&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">input</span>    <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_KptaProc_input_iter__</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_KptaProc_output_iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetOutputPulseSize</span><span class="p">():</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetOutputPulse</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>                  
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">_libpyroot</span><span class="o">.</span><span class="n">MakeRootClass</span><span class="p">(</span> <span class="s">&quot;KPtaProcessor&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">output</span>    <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_KptaProc_output_iter__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_KptaProc_input_iter_index__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetInputPulseSize</span><span class="p">():</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetInputPulse</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span>                 
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">_libpyroot</span><span class="o">.</span><span class="n">MakeRootClass</span><span class="p">(</span> <span class="s">&quot;KPtaProcessor&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">input_index</span>    <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_KptaProc_input_iter_index__</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_KptaProc_output_iter_index__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetOutputPulseSize</span><span class="p">():</span>
    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetOutputPulse</span><span class="p">()[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span>                
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">_libpyroot</span><span class="o">.</span><span class="n">MakeRootClass</span><span class="p">(</span> <span class="s">&quot;KPtaProcessor&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">output_index</span>    <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_KptaProc_output_iter_index__</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">KDataUtilQuitLoop</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span> 


<span class="c">#small utility functions  </span>
<div class="viewcode-block" id="get_as_nparray"><a class="viewcode-back" href="../../util.html#KDataPy.util.get_as_nparray">[docs]</a><span class="k">def</span> <span class="nf">get_as_nparray</span><span class="p">(</span><span class="n">c_pointer</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  </span>
<span class="sd">  return a numpy array from a pointer to data of length &#39;size&#39;</span>
<span class="sd">  </span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_pointer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">data</span>
</div>
<div class="viewcode-block" id="get_out"><a class="viewcode-back" href="../../util.html#KDataPy.util.get_out">[docs]</a><span class="k">def</span> <span class="nf">get_out</span><span class="p">(</span><span class="n">pta</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  </span>
<span class="sd">  return a numpy array from the output pulse of a KPtaProcessor (pta)</span>
<span class="sd">  </span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="n">get_as_nparray</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">GetOutputPulse</span><span class="p">(),</span> <span class="n">pta</span><span class="o">.</span><span class="n">GetOutputPulseSize</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="get_in"><a class="viewcode-back" href="../../util.html#KDataPy.util.get_in">[docs]</a><span class="k">def</span> <span class="nf">get_in</span><span class="p">(</span><span class="n">pta</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">  return a numpy array from the input pulse of a KPtaProcessor (pta)</span>
<span class="sd">  </span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="n">get_as_nparray</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">GetInputPulse</span><span class="p">(),</span> <span class="n">pta</span><span class="o">.</span><span class="n">GetInputPulseSize</span><span class="p">())</span>
    </div>
<div class="viewcode-block" id="getRootHistFromOutput"><a class="viewcode-back" href="../../util.html#KDataPy.util.getRootHistFromOutput">[docs]</a><span class="k">def</span> <span class="nf">getRootHistFromOutput</span><span class="p">(</span><span class="n">pta</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  </span>
<span class="sd">  return a ROOT TH1D histogram from the output pulse of a KPtaProcessor (pta)</span>
<span class="sd">  </span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">h</span> <span class="o">=</span> <span class="n">TH1D</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span> <span class="n">pta</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span> <span class="n">pta</span><span class="o">.</span><span class="n">GetOutputPulseSize</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pta</span><span class="o">.</span><span class="n">GetOutputPulseSize</span><span class="p">())</span>
  <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="n">pta</span><span class="o">.</span><span class="n">output_index</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">h</span>

</div>
<div class="viewcode-block" id="looppulse"><a class="viewcode-back" href="../../util.html#KDataPy.util.looppulse">[docs]</a><span class="k">def</span> <span class="nf">looppulse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">analysisFunction</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  This function provides you with automatic looping code and gives you the chance for pulse processing. </span>
<span class="sd">  This function will loop through a datafile, apply the KPulseProcessor that you provide (in pta), </span>
<span class="sd">  and then call the analysisFunction, passing in the pulseRecord, the pta, and all kwargs. </span>
<span class="sd">  This function allows for all KData types (Raw, Amp, HLA). Only events in Raw data files are processed with the</span>
<span class="sd">  KPtaProcessor object, of course.</span>

<span class="sd">  :param data: The data file to use.</span>
<span class="sd">  :type data: string path to file or KDataReader object</span>
<span class="sd">  :param name: The channel name you want to analyze</span>
<span class="sd">  :type name: string</span>
<span class="sd">  :param match: if match is True, then the detector name needs to exactly match &#39;name&#39;. Otherwise, if the pulse channel name contains &#39;name&#39;, then the data will be analyzed. For example, if you set &#39;name&#39;=&#39;chal&#39;, then you will probably analyze all heat channels</span>
<span class="sd">  :type match: bool</span>
<span class="sd">  :param pta: a KPtaProcessor that will be automatically called for each pulse</span>
<span class="sd">  :type pta: KPtaProcessor object</span>
<span class="sd">  :param analysisFunction: the function that you will define to analyze your pulse. This is a sort of &#39;callback&#39; function. Your function must have three arguments(KEvent, KBoloPulseRecord, KPtaProcessor, kwargs). The KPtaProcessor will be the same object that you pass into pta</span>
<span class="sd">  :type analysisFunction: function pointer</span>
<span class="sd">  :param kwargs: all kwargs are pass to the analysisFunction</span>
<span class="sd">  :type kwargs: keyword argument list</span>


<span class="sd">    </span>
<span class="sd">  </span>
<span class="sd">  Example 1</span>
<span class="sd">  </span>
<span class="sd">  .. code-block:: python</span>

<span class="sd">     from KDataPy import util</span>
<span class="sd">     from ROOT import *</span>
<span class="sd">     gSystem.Load(&#39;libkpta&#39;)</span>
<span class="sd">  </span>
<span class="sd">     #here i define the analysis function</span>
<span class="sd">     def myFunction(theEvent, pulseRecord, ptaObject=None, **kwargs):</span>
<span class="sd">       print pulseRecord.GetChannelName()</span>
<span class="sd">    </span>
<span class="sd">       if ptaObject != None</span>
<span class="sd">         pulsetrace = util.get_out(pta)</span>
<span class="sd">       else: pulsetrace = np.array(pulse.GetTrace())</span>

<span class="sd">       print &#39;the pulse maximum is&#39;, np.amax(pulsetrace), &#39;at bin&#39;, np.argmax(pulsetrace)</span>
<span class="sd">  </span>
<span class="sd">     #a KPtaProcessor object that will analyse each pulse</span>
<span class="sd">     bas = KBaselineRemoval()</span>
<span class="sd">  </span>
<span class="sd">     util.looppulse(&#39;path/to/kdatafile.root&#39;, name=&#39;ZM1&#39;, pta = bas, analysisFunction = myFunction)</span>
<span class="sd">  </span>
<span class="sd">  </span>
<span class="sd">  Example 2</span>
<span class="sd">  </span>
<span class="sd">  .. code-block:: python</span>
<span class="sd">    </span>
<span class="sd">    from KDataPy import util</span>
<span class="sd">    from ROOT import *</span>
<span class="sd">    gSystem.Load(&#39;libkpta&#39;)</span>
<span class="sd">  </span>
<span class="sd">    #here i define the analysis function</span>
<span class="sd">    def myFunction(theEvent, pulseRecord, ptaObject=None, **kwargs):</span>
<span class="sd">      print pulseRecord.GetChannelName()</span>
<span class="sd">    </span>
<span class="sd">      if ptaObject != None</span>
<span class="sd">        pulsetrace = util.get_out(pta)</span>
<span class="sd">      else: pulsetrace = np.array(pulse.GetTrace())</span>

<span class="sd">      print &#39;the pulse maximum is&#39;, np.amax(pulsetrace), &#39;at bin&#39;, np.argmax(pulsetrace)</span>
<span class="sd">    </span>
<span class="sd">    bas = KBaselineRemoval()</span>
<span class="sd">    pat = KPatternRemoval()</span>
<span class="sd">    chain = KPulseAnalysisChain()</span>
<span class="sd">    chain.AddProcessor(bas)</span>
<span class="sd">    chain.AddProcessor(pat)</span>
<span class="sd">  </span>
<span class="sd">    util.looppulse(&#39;/sps/edelweis/kdata/data/raw/me20a010_010.root&#39;, name = &#39;ZM1&#39;, pta = chain, analysisFunction = myFunction)</span>
<span class="sd">  </span>
<span class="sd">  </span>
<span class="sd">  Example 3 - using kwargs</span>
<span class="sd">  </span>
<span class="sd">  .. code-block:: python</span>

<span class="sd">    from KDataPy import util</span>
<span class="sd">    import numpy as np</span>
<span class="sd">    from ROOT import *</span>
<span class="sd">    gSystem.Load(&#39;libkpta&#39;)</span>

<span class="sd">    </span>
<span class="sd">    def myAnalysis(theEvent, pulse, pta, **kwargs):</span>
<span class="sd">      if pta != None</span>
<span class="sd">        pulsetrace = util.get_out(pta)</span>
<span class="sd">      else: pulsetrace = np.array(pulse.GetTrace())</span>
<span class="sd">      </span>
<span class="sd">      if kwargs[&#39;myExtraOption&#39;] == &#39;printMin&#39;:</span>
<span class="sd">        print &#39;the pulse minimum is&#39;, np.amin(pulsetrace), &#39;at bin&#39;, np.argmin(pulsetrace)</span>
<span class="sd">      else:</span>
<span class="sd">        print &#39;the pulse maximum is&#39;, np.amax(pulsetrace), &#39;at bin&#39;, np.argmax(pulsetrace)</span>
<span class="sd">        </span>
<span class="sd">    bas = KBaselineRemoval()</span>
<span class="sd">    pat = KPatternRemoval()</span>
<span class="sd">    filter = KIIRSecondOrder(a1, a2, b0, b1, b2)  #the &quot;a&quot; and &quot;b&quot; variables can be calculated by external tools (such as Scipy.signal)</span>
<span class="sd">    chain = KPulseAnalysisChain()</span>
<span class="sd">    chain.AddProcessor(bas)</span>
<span class="sd">    chain.AddProcessor(pat)</span>
<span class="sd">    chain.AddProcessor(filter)</span>

<span class="sd">    util.looppulse(&#39;/sps/edelweis/kdata/data/raw/me20a010_010.root&#39;, name = &#39;ZM1&#39;, pta = chain, analysisFunction = myAnalysis, myExtraOption=&quot;printMin&quot;)</span>
<span class="sd">      </span>
<span class="sd">  </span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">if</span> <span class="s">&#39;KDataReader&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span> <span class="n">kdfilereader</span> <span class="o">=</span> <span class="n">data</span> 
  <span class="k">else</span><span class="p">:</span>
    <span class="n">kdfilereader</span> <span class="o">=</span> <span class="n">KDataPy</span><span class="o">.</span><span class="n">KDataReader</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
  <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">kdfilereader</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">pulse</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">boloPulseRecords</span><span class="p">():</span>
      
      <span class="k">if</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetPulseLength</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
      <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">():</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">==</span><span class="bp">True</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">():</span> <span class="k">continue</span>
      
      <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pta</span><span class="p">:</span>
          <span class="n">pta</span><span class="o">.</span><span class="n">SetInputPulse</span><span class="p">(</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetTrace</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">pta</span><span class="o">.</span><span class="n">RunProcess</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c">#ignore. probably because the pulse.GetTrace method doesn&#39;t exist because this file is not a raw level kdata file</span>

      <span class="k">if</span> <span class="n">analysisFunction</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">analysisFunction</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">pta</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">KDataUtilQuitLoop</span><span class="p">:</span>
          <span class="k">return</span>
   </div>
<div class="viewcode-block" id="loopbolo"><a class="viewcode-back" href="../../util.html#KDataPy.util.loopbolo">[docs]</a><span class="k">def</span> <span class="nf">loopbolo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ptaDictionary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">analysisFunction</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Like looppulse, but just loops through each bolo record for you</span>
<span class="sd">  and you provide the analysis function. However, you can also supply a dictionary object that has the pulse</span>
<span class="sd">  channel names for keys and KPtaProcessor objects as values. Before your analysisFunction is called,</span>
<span class="sd">  these KPtaProcessors will be applied to the appropriate pulses. See the examples below.</span>
<span class="sd">  </span>
<span class="sd">  :param data: The data file to use.</span>
<span class="sd">  :type data:  string, or KDataReader object</span>
<span class="sd">  :param name: The bolometer name you want to analyze</span>
<span class="sd">  :type name: string</span>
<span class="sd">  :param match: if match is True, then the bolometer name needs to exactly match &#39;name&#39;. Otherwise, if the bolometer name contains &#39;name&#39;, then the data will be analyzed. For example, if you set &#39;name&#39;=&#39;FID&#39;, then your analysis function will be called for each FID detector in the file</span>
<span class="sd">  :type match: bool</span>
<span class="sd">  :param ptaDictionary: A dictionary of references to pta Objects. Each &#39;key&#39; is the channel name and the value is the KPtaProcessor that will be applied to that channel&#39;s pulse before the analysisFunction is called.</span>
<span class="sd">  :type ptaDictionary: dict </span>
<span class="sd">  :param analysisFunction: the function that you define to analyze the bolometer record. You must supply this callback function.  The function will be passed the following arguments: KEvent, KBolometerRecord, ptaDictionary, kwargs. </span>
<span class="sd">  :type analysisFunction: function pointer</span>
<span class="sd">  :param kwargs: all remaining kwargs are pass to the analysisFunction</span>
<span class="sd">  :type kwargs: keyword argument list</span>

<span class="sd">  For example</span>
<span class="sd">  </span>
<span class="sd">  .. code-block:: python</span>

<span class="sd">    import KDataPy.util</span>

<span class="sd">    def myFunction(theEvent, boloRecord, ptaDict=None,  **kwargs):</span>
<span class="sd">      print boloRecord.GetDetectorName()</span>
<span class="sd">      </span>
<span class="sd">      for pulse in boloRecord.pulseRecords():</span>
<span class="sd">        print pulse.GetChannelName()</span>
<span class="sd">          if kwargs[&#39;myExtraOptions&#39;] == &#39;condition1&#39;:</span>
<span class="sd">            .... do some analysis....</span>
<span class="sd">          else:</span>
<span class="sd">            .... do something different....</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    KDataPy.util.loopbolo(&#39;/path/to/file.root&#39;, name=&quot;FID&quot;, analysisFunction=myFunction, myExtraOptions=&quot;condition1&quot;)</span>
<span class="sd">    </span>
<span class="sd"> </span>
<span class="sd">  Besides strings, you can pass ANYTHING via the kwargs, in any order, even objects, and pointers to other functions.</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    import KDataPy.util</span>
<span class="sd">    from ROOT import *</span>

<span class="sd">    def callMe():</span>
<span class="sd">      print &#39;I can be called&#39;</span>


<span class="sd">    def myFunction(theEvent, boloRecord, ptaDict=None, **kwargs):</span>
<span class="sd">      print boloRecord.GetDetectorName()</span>
<span class="sd">      </span>
<span class="sd">      if kwargs[&#39;firstCall&#39;]:</span>
<span class="sd">        kwargs[&#39;firstCall&#39;]()</span>

<span class="sd">      hAna = kwargs[&#39;heatAna&#39;]</span>
<span class="sd">      ionAna = kwargs[&#39;ionAna&#39;]</span>

<span class="sd">      for pulse in boloRecord.pulseRecords():</span>
<span class="sd">        print pulse.GetChannelName()</span>

<span class="sd">        #pick the correct analysis object</span>
<span class="sd">        if pulse.GetIsHeatPulse():</span>
<span class="sd">          theAna = hAna</span>
<span class="sd">        else:</span>
<span class="sd">          theAna = ionAna</span>

<span class="sd">        theAna.SetInputPulse(pulse.GetTrace())</span>
<span class="sd">        theAna.RunProcess()</span>
<span class="sd">        outTrace = util.get_out(theAna)</span>
<span class="sd">          ... do something ...</span>


<span class="sd">        </span>
<span class="sd">    chainHeat = KPulseAnalysisChain()</span>
<span class="sd">    chainHeat.AddProcessor( KBaselineRemoval() )</span>

<span class="sd">    chainIon = KPulseAnalysisChain()</span>
<span class="sd">    chainIon.AddProcessor( KBaselineRemoval() )</span>
<span class="sd">    chainIon.AddProcessor( KPatternRemoval() )</span>

<span class="sd">    util.loopbolo(&#39;/path/to/file.root&#39;, name=&quot;FID&quot;, analysisFunction=myFunction, heatAna = chainHeat, ionAna = chainIon, firstCall = callMe)</span>

<span class="sd">  This final example shows how to use the ptaDictionary, which should save you some lines of code in your anaysisFunction.</span>

<span class="sd">  .. code-block:: python</span>

<span class="sd">    from KDataPy import util</span>
<span class="sd">    import ROOT</span>
<span class="sd">    ROOT.gSystem.Load(&#39;libkds&#39;)</span>
<span class="sd">    ROOT.gSystem.Load(&#39;libkpta&#39;)</span>

<span class="sd">    def myFunction(theEvent, boloRecord, ptaDict=None, **kwargs):</span>
<span class="sd">      print boloRecord.GetDetectorName()</span>

<span class="sd">      for pulse in boloRecord.pulseRecords():</span>
<span class="sd">        </span>
<span class="sd">        outTrace = KDataPy.util.get_out( ptaDict[pulse.GetChannelName()])</span>
<span class="sd">          # do something </span>


<span class="sd">    chainHeat =ROOT.KPulseAnalysisChain()</span>
<span class="sd">    chainHeat.AddProcessor(ROOT.KBaselineRemoval() )</span>

<span class="sd">    chainIon1 =ROOT.KPulseAnalysisChain()</span>
<span class="sd">    chainIon1.AddProcessor(ROOT.KBaselineRemoval() )</span>
<span class="sd">    chainIon1.AddProcessor(ROOT.KPatternRemoval() )</span>

<span class="sd">    chainIon2 =ROOT.KPulseAnalysisChain()</span>
<span class="sd">    chainIon2.AddProcessor(ROOT.KLinearRemoval() )</span>
<span class="sd">    chainIon.AddProcessor(ROOT.KPatternRemoval() )</span>

<span class="sd">    myPtaDict = {}</span>
<span class="sd">    myPtaDict[&#39;chalA FID807&#39;] = chainHeat</span>
<span class="sd">    myPtaDict[&#39;chalB FID807&#39;] = chainHeat</span>

<span class="sd">    myPtaDict[&#39;ionisA FID807&#39;] = chainIon1</span>
<span class="sd">    myPtaDict[&#39;ionisB FID807&#39;] = chainIon1</span>
<span class="sd">    myPtaDict[&#39;ionisC FID807&#39;] = chainIon2</span>
<span class="sd">    myPtaDict[&#39;ionisD FID807&#39;] = chainIon2</span>


<span class="sd">    util.loopbolo(&#39;/path/to/file.root&#39;, name=&quot;FID&quot;, ptaDictionary = myPtaDict, analysisFunction=myFunction)</span>


<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">if</span> <span class="n">analysisFunction</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;You must provide an analysis function&#39;</span>
    <span class="k">return</span>
    
  <span class="k">if</span> <span class="s">&#39;KDataReader&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span> <span class="n">kdfilereader</span> <span class="o">=</span> <span class="n">data</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">kdfilereader</span> <span class="o">=</span> <span class="n">KDataPy</span><span class="o">.</span><span class="n">KDataReader</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
  <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">kdfilereader</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">bolo</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">boloRecords</span><span class="p">():</span>
      
      <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bolo</span><span class="o">.</span><span class="n">GetDetectorName</span><span class="p">():</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">==</span><span class="bp">True</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">bolo</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">():</span> <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">ptaDictionary</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">pulse</span> <span class="ow">in</span> <span class="n">bolo</span><span class="o">.</span><span class="n">pulseRecords</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetPulseLength</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>  <span class="c">#skip empty pulses</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="n">ptaDictionary</span><span class="p">[</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">()]</span><span class="o">.</span><span class="n">SetInputPulse</span><span class="p">(</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetTrace</span><span class="p">())</span>
              <span class="k">if</span> <span class="n">ptaDictionary</span><span class="p">[</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">()]</span><span class="o">.</span><span class="n">RunProcess</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">KDataPy</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">KDataError</span><span class="p">(</span><span class="s">&#39;RunProcess failed in plotbolo&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="o">!=</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">():</span> 
                <span class="k">raise</span> <span class="n">e</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">analysisFunction</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">bolo</span><span class="p">,</span> <span class="n">ptaDictionary</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">KDataUtilQuitLoop</span><span class="p">:</span>
          <span class="k">return</span>
            </div>
<div class="viewcode-block" id="plotpulse"><a class="viewcode-back" href="../../util.html#KDataPy.util.plotpulse">[docs]</a><span class="k">def</span> <span class="nf">plotpulse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pta</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">analysisFunction</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exactly like looppulse, but will plot each raw pulse on screen and wait for you to hit the &#39;Enter&#39;</span>
<span class="sd">    key in the shell before continuing. In fact, this function calls looppulse. This is a nice way to visualize what is happening</span>
<span class="sd">    to the pulses. Additionally, if you don&#39;t provide any analysisFunction, it will be a</span>
<span class="sd">    nice event viewer just to look at the data.  This function will only work with KData Raw-level files. That is, its only</span>
<span class="sd">    meant for plotting the pulse traces, which only exist in the raw data files. Otherwise, this will raise an exception at run-time.</span>
<span class="sd">    This function plot to matplotlib figure(0)! So, don&#39;t use figure(0) or it will be cleared and a pulse will be drawn.</span>

<span class="sd">    You can quit the loop by typing &#39;quit&#39;, &#39;q&#39;, &#39;bye&#39;, or &#39;-q&#39; on the command-line</span>

<span class="sd">    :param data: The data file to use.</span>
<span class="sd">    :type data: string path to file or KDataReader object</span>
<span class="sd">    :param name: The channel name you want to analyze</span>
<span class="sd">    :type name: string</span>
<span class="sd">    :param match: if match is True, then the pulse channel name needs to exactly match &#39;name&#39;. Otherwise, if the pulse channel name contains &#39;name&#39;, then the data will be analyzed. For example, if you set &#39;name&#39;=&#39;chal&#39;, then you will probably analyze all heat channels</span>
<span class="sd">    :type match: bool</span>
<span class="sd">    :param pta: a KPtaProcessor that will be automatically called for each pulse</span>
<span class="sd">    :type pta: KPtaProcessor object</span>
<span class="sd">    :param analysisFunction: the function that you will define to analyze your pulse. This is a sort of &#39;callback&#39; function. Your function must have three arguments(KEvent, KBoloPulseRecord, KPtaProcessor, kwargs). The KPtaProcessor will be the same object that you pass into pta</span>
<span class="sd">    :type analysisFunction: function pointer</span>
<span class="sd">    :param kwargs: all kwargs are pass to the analysisFunction</span>
<span class="sd">    :type kwargs: keyword argument list</span>


<span class="sd">    Example Event Viewer. This will just print to screen every pulse shape for any channel with &quot;ZM&quot; in its name</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      from KDataPy import util</span>

<span class="sd">      util.plotpulse(&#39;/sps/edelweis/kdata/data/raw/me20a010_010.root&#39;, name = &#39;ZM&#39;)</span>


<span class="sd">    &#39;&#39;&#39;</span>
        
    <span class="c">#hey - maybe i should use a decorator to &quot;subclass&quot; the looppulse function!.  how do i do that? </span>
    <span class="c">##. this is much more robust than using __callersAnalysisFunction. perhaps....</span>
    <span class="c">#</span>

    <span class="k">def</span> <span class="nf">__plotingfunction</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">pta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            
      
      <span class="k">print</span> <span class="s">&#39;plotting&#39;</span><span class="p">,</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">()</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">pta</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pta</span><span class="o">.</span><span class="n">SetInputPulse</span><span class="p">(</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetTrace</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">pta</span><span class="o">.</span><span class="n">RunProcess</span><span class="p">()</span>
        <span class="n">dataPulse</span> <span class="o">=</span> <span class="n">get_out</span><span class="p">(</span><span class="n">pta</span><span class="p">)</span>
        
      <span class="k">else</span><span class="p">:</span>
        <span class="n">dataPulse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetTrace</span><span class="p">())</span>
        
        
      <span class="n">yMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dataPulse</span><span class="p">)</span>
      <span class="n">yMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dataPulse</span><span class="p">)</span>
      <span class="n">yMaxNew</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yMax</span> <span class="o">-</span> <span class="n">yMin</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span> <span class="o">+</span> <span class="n">yMax</span>
      <span class="n">yMinNew</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">yMax</span> <span class="o">-</span> <span class="n">yMin</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span> <span class="o">+</span><span class="n">yMin</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dataPulse</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yMinNew</span><span class="p">,</span> <span class="n">yMaxNew</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">())</span>
        <span class="c">#plt.show()</span>
        
      
        
      <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;__callersAnalysisFunction&#39;</span><span class="p">]:</span>
        <span class="n">newkwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">newkwargs</span><span class="p">[</span><span class="s">&#39;__callersAnalysisFunction&#39;</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;__callersAnalysisFunction&#39;</span><span class="p">](</span><span class="n">event</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">pta</span><span class="p">,</span> <span class="o">**</span><span class="n">newkwargs</span><span class="p">)</span>
      
      <span class="k">try</span><span class="p">:</span>
        <span class="n">quitmessage</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">quitmessage</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;quit&#39;</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="s">&#39;bye&#39;</span><span class="p">,</span> <span class="s">&#39;-q&#39;</span><span class="p">]:</span> 
          <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
          <span class="k">raise</span> <span class="n">KDataUtilQuitLoop</span><span class="p">(</span><span class="n">quitmessage</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span>
      
      <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
      
      
    <span class="n">looppulse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">match</span><span class="p">,</span> <span class="n">pta</span> <span class="o">=</span> <span class="n">pta</span><span class="p">,</span> <span class="n">analysisFunction</span> <span class="o">=</span> <span class="n">__plotingfunction</span><span class="p">,</span> <span class="n">__callersAnalysisFunction</span> <span class="o">=</span> <span class="n">analysisFunction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  
    
</div>
<div class="viewcode-block" id="plotbolo"><a class="viewcode-back" href="../../util.html#KDataPy.util.plotbolo">[docs]</a><span class="k">def</span> <span class="nf">plotbolo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ptaDictionary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">analysisFunction</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Exactly like loopbolo, but will plot each raw pulse on screen and wait for you to hit the &#39;Enter&#39;</span>
<span class="sd">    key in the shell before continuing. In fact, this function calls loopbolo. This is a nice way to visualize what is happening</span>
<span class="sd">    to the pulses. Additionally, if you don&#39;t provide any analysisFunction, it will be a</span>
<span class="sd">    nice event viewer just to look at the data.  This function will only work with KData Raw-level files. That is, its only</span>
<span class="sd">    meant for plotting the pulse traces, which only exist in the raw data files. Otherwise, this will raise an exception at run-time.</span>
<span class="sd">    This function plot to matplotlib figure(0)! So, don&#39;t use figure(0) or it will be cleared and a pulse will be drawn.</span>

<span class="sd">    You can quit the loop by typing &#39;quit&#39;, &#39;q&#39;, &#39;bye&#39;, or &#39;-q&#39; on the command-line</span>

<span class="sd">    :param data: The data file to use.</span>
<span class="sd">    :type data:  string, or KDataReader object</span>
<span class="sd">    :param name: The bolometer name you want to analyze</span>
<span class="sd">    :type name: string</span>
<span class="sd">    :param match: if match is True, then the bolometer name needs to exactly match &#39;name&#39;. Otherwise, if the bolometer name contains &#39;name&#39;, then the data will be analyzed. For example, if you set &#39;name&#39;=&#39;FID&#39;, then your analysis function will be called for each FID detector in the file</span>
<span class="sd">    :type match: bool</span>
<span class="sd">    :param ptaDictionary: A dictionary of references to pta Objects. Each &#39;key&#39; is the channel name and the value is the KPtaProcessor that will be applied to that channel&#39;s pulse before the analysisFunction is called.</span>
<span class="sd">    :type ptaDictionary: dict </span>
<span class="sd">    :param analysisFunction: the function that you define to analyze the bolometer record. You must supply this callback function.  The function will be passed the following arguments: KEvent, KBolometerRecord, ptaDictionary, axisDictionary, kwargs. The axisDictionary is a dictionary of matplotlib.pyplot.Axis objects that are created for each subplot in the figure. You can use these to alter how your plot looks</span>
<span class="sd">    :type analysisFunction: function pointer</span>
<span class="sd">    :param kwargs: all remaining kwargs are pass to the analysisFunction</span>
<span class="sd">    :type kwargs: keyword argument list</span>

<span class="sd">    Example Event Viewer. This will just print to screen all pulses for any detector with &quot;FID&quot; in its name</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      from KDataPy import util</span>

<span class="sd">      util.plotbolo(&#39;/sps/edelweis/kdata/data/raw/me20a010_010.root&#39;, name = &#39;FID&#39;)</span>

<span class="sd">    &#39;&#39;&#39;</span>
        
    <span class="c">#hey - maybe i should use a decorator to &quot;subclass&quot; the looppulse function!.  how do i do that? </span>
    <span class="c">##. this is much more robust than using __callersAnalysisFunction. perhaps....</span>
    <span class="c">#</span>

    <span class="k">def</span> <span class="nf">__plotingfunction__</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">bolo</span><span class="p">,</span> <span class="n">ptaDictionary</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            
      <span class="n">axisDict</span> <span class="o">=</span> <span class="p">{}</span>
      
      <span class="k">print</span> <span class="s">&#39;plotting&#39;</span><span class="p">,</span> <span class="n">bolo</span><span class="o">.</span><span class="n">GetDetectorName</span><span class="p">()</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

      <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="n">pulse</span> <span class="ow">in</span> <span class="n">bolo</span><span class="o">.</span><span class="n">pulseRecords</span><span class="p">():</span>


        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">bolo</span><span class="o">.</span><span class="n">GetNumPulseRecords</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetPulseLength</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
          <span class="k">continue</span>

        <span class="n">axisDict</span><span class="p">[</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">())</span>
        

        <span class="k">if</span> <span class="n">ptaDictionary</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">tobeplotted</span> <span class="o">=</span> <span class="n">get_out</span><span class="p">(</span><span class="n">ptaDictionary</span><span class="p">[</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">()])</span>

          <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="o">!=</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">():</span> <span class="k">raise</span> <span class="n">e</span>
            <span class="n">tobeplotted</span> <span class="o">=</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetTrace</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">tobeplotted</span> <span class="o">=</span> <span class="n">pulse</span><span class="o">.</span><span class="n">GetTrace</span><span class="p">()</span>

        <span class="n">yMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tobeplotted</span><span class="p">)</span>
        <span class="n">yMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tobeplotted</span><span class="p">)</span>
        <span class="n">yMaxNew</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yMax</span> <span class="o">-</span> <span class="n">yMin</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span> <span class="o">+</span> <span class="n">yMax</span>
        <span class="n">yMinNew</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">yMax</span> <span class="o">-</span> <span class="n">yMin</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span> <span class="o">+</span><span class="n">yMin</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tobeplotted</span> <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yMinNew</span><span class="p">,</span> <span class="n">yMaxNew</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">pulse</span><span class="o">.</span><span class="n">GetChannelName</span><span class="p">())</span>

      
        
      <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;__callersAnalysisFunction__&#39;</span><span class="p">]:</span>
        <span class="n">newkwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">newkwargs</span><span class="p">[</span><span class="s">&#39;__callersAnalysisFunction__&#39;</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;__callersAnalysisFunction__&#39;</span><span class="p">](</span><span class="n">event</span><span class="p">,</span> <span class="n">bolo</span><span class="p">,</span> <span class="n">ptaDictionary</span><span class="p">,</span> <span class="n">axisDict</span><span class="p">,</span> <span class="o">**</span><span class="n">newkwargs</span><span class="p">)</span>
      
      <span class="k">try</span><span class="p">:</span>
        <span class="n">quitmessage</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">quitmessage</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;quit&#39;</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="s">&#39;bye&#39;</span><span class="p">,</span> <span class="s">&#39;-q&#39;</span><span class="p">]:</span> 
          <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
          <span class="k">raise</span> <span class="n">KDataUtilQuitLoop</span><span class="p">(</span><span class="n">quitmessage</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span>
      
      <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
      
      
    <span class="n">loopbolo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">match</span><span class="p">,</span> <span class="n">ptaDictionary</span> <span class="o">=</span> <span class="n">ptaDictionary</span><span class="p">,</span> <span class="n">analysisFunction</span> <span class="o">=</span> <span class="n">__plotingfunction__</span><span class="p">,</span> <span class="n">__callersAnalysisFunction__</span> <span class="o">=</span> <span class="n">analysisFunction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  
        
        
</div>
<div class="viewcode-block" id="concatKdataFiles"><a class="viewcode-back" href="../../util.html#KDataPy.util.concatKdataFiles">[docs]</a><span class="k">def</span> <span class="nf">concatKdataFiles</span><span class="p">(</span><span class="n">fileList</span><span class="p">,</span> <span class="n">outputFileName</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function performs a very simple operation. Given a list of KData file names (full path), fileList, it will merge the TTrees</span>
<span class="sd">    within these files into a single output file with name &quot;outputFileName&quot;. This function should work for all types of KData files (Raw, Amp, HLA)</span>
<span class="sd">    </span>
<span class="sd">    :param fileList: The KData files to merge</span>
<span class="sd">    :type fileList: list of full paths to the files</span>
<span class="sd">    :param outputFileName: The name of the output KData file</span>
<span class="sd">    :type name: string</span>

<span class="sd">    [Developer&#39;s note: This assumes that the name of the TTree within the KData file is called &#39;t&#39;]</span>
<span class="sd">  &#39;&#39;&#39;</span>


  <span class="n">listOfTFiles</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">listOfTrees</span> <span class="o">=</span> <span class="n">TList</span><span class="p">()</span>

  <span class="k">print</span> <span class="s">&#39;attempting to merge the following files&#39;</span>
  <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fileList</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">fname</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">TFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">listOfTFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&#39;doesnt appear to be a kdata file. no tree with name &quot;t&quot; found. quiting.&#39;</span>
      <span class="k">return</span>
    <span class="n">listOfTrees</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">))</span>
  
  <span class="k">print</span> <span class="s">&#39;output file:&#39;</span><span class="p">,</span> <span class="n">outputFileName</span>
  <span class="n">fout</span> <span class="o">=</span> <span class="n">TFile</span><span class="p">(</span><span class="n">outputFileName</span><span class="p">,</span> <span class="s">&#39;recreate&#39;</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">&#39;starting the merge...&#39;</span>
  <span class="n">outTree</span> <span class="o">=</span> <span class="n">TTree</span><span class="o">.</span><span class="n">MergeTrees</span><span class="p">(</span><span class="n">listOfTrees</span><span class="p">,</span> <span class="s">&#39;fast&#39;</span><span class="p">)</span>
  <span class="n">outTree</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
  <span class="n">fout</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
  <span class="k">print</span> <span class="s">&#39;done&#39;</span>


  
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">KDataPy 5.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Adam Cox, KIT.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>